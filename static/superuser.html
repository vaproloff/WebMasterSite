{% extends "base.html" %}
{% block content %}
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
<style>
    body {
        font-family: Arial, sans-serif;
        text-align: center;
        background-color: #f8f9fa;
        color: #343a40;
    }
    .container {
        margin: 0 auto;
        width: 80%;
        max-width: 800px;
    }
    .header {
        margin-top: 20px;
    }
    .header h1 {
        color: #007bff;
    }
    .change-role, .add-group, .delete-group, .new-block {
        display: inline-block;
        vertical-align: top;
        width: 40%;
        margin: 20px 0;
    }
    .change-role, .delete-group, .new-block {
        text-align: center;
    }
    .add-group {
        text-align: left;
    }
    .change-role h2, .add-group h2, .delete-group h2, .new-block h2 {
        color: #007bff;
    }
    .buttons {
        margin-top: 20px;
    }
    .buttons a, .buttons button {
        display: block;
        margin: 10px auto;
        padding: 10px 20px;
        font-size: 16px;
        background-color: #007bff;
        color: #fff;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        width: 200px; /* Одинаковый размер кнопок */
        text-decoration: none;
        text-align: center;
    }
    .buttons a:hover, .buttons button:hover {
        background-color: #0056b3;
    }
    .form {
        margin-top: 20px;
    }
    .form input, .form button {
        display: block;
        margin: 10px auto;
        padding: 10px;
        width: 80%;
        font-size: 16px;
        border: 1px solid #ced4da;
        border-radius: 5px;
    }
    .form button {
        background-color: #007bff;
        color: #fff;
        border: none;
        cursor: pointer;
    }
    .form button:hover {
        background-color: #0056b3;
    }
    .add-group {
        margin-left: 50px; /* Увеличенное расстояние между блоками */
    }
    .add-group h2 {
        margin-left: 60px; /* Подвинуть надпись "add group" немного вправо */
    }
    .loader {
        position: fixed;
        z-index: 9999;
        top: 10%;
        left: 40%;
        transform: translate(-50%, -50%);
        border: 4px solid #f3f3f3;
        border-radius: 50%;
        border-top: 4px solid #3498db;
        width: 50px;
        height: 50px;
        -webkit-animation: spin 2s linear infinite; /* Safari */
        animation: spin 2s linear infinite;
    }
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    /* Стилизация выпадающего списка */
    .form select {
        display: block;
        margin: 10px auto;
        padding: 10px;
        width: 80%;
        font-size: 16px;
        border: 1px solid #ced4da;
        border-radius: 5px;
        background-color: #fff;
        color: #343a40;
        appearance: none; /* Убираем стандартный стиль браузера */
        -webkit-appearance: none; /* Убираем стиль для Safari */
        -moz-appearance: none; /* Убираем стиль для Firefox */
    }

    .form select:focus {
        outline: none;
        border-color: #007bff;
    }

    .form select option {
        padding: 10px;
    }

    /* Стиль для контейнера выпадающего списка */
    .form select-wrapper {
        position: relative;
        display: inline-block;
        width: 80%;
    }

    .form select-wrapper::after {
        content: '▼'; /* Символ стрелки вниз */
        position: absolute;
        top: 50%;
        right: 10px;
        transform: translateY(-50%);
        pointer-events: none;
        color: #007bff;
    }
</style>
<style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
        }
        .table-container {
            display: table;
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            transition: margin-top 0.3s;
        }
        .row {
            display: table-row;
        }
        .header {
            background-color: #f2f2f2;
            font-weight: bold;
        }
        .cell {
            display: table-cell;
            padding: 10px;
            border: 1px solid #ddd;
            text-align: center;
        }
        .cell a {
            color: #007BFF;
            text-decoration: none;
        }
        .cell a:hover {
            text-decoration: underline;
        }
        button {
            padding: 5px 10px;
            border: none;
            cursor: pointer;
            transition: background-color 0.3s, transform 0.2s;
        }
        .edit-btn {
            background-color: orange;
            color: white;
            border-radius: 4px;
        }
        .edit-btn:hover {
            background-color: darkorange;
            transform: scale(1.05);
        }
        .delete-btn {
            background-color: red;
            color: white;
            border-radius: 4px;
        }
        .delete-btn:hover {
            background-color: darkred;
            transform: scale(1.05);
        }
        .group-list-btn {
            background-color: blue;
            color: white;
            border-radius: 4px;
        }
        .group-list-btn:hover {
            background-color: darkblue;
            transform: scale(1.05);
        }
        .add-btn {
            background-color: green;
            color: white;
            padding: 10px;
            font-size: 18px;
            border-radius: 4px;
            margin-bottom: 10px;
            transition: background-color 0.3s, transform 0.2s;
        }
        .add-btn:hover {
            background-color: darkgreen;
            transform: scale(1.05);
        }
        #addConfigForm {
            margin-bottom: 20px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            display: none;
            opacity: 0;
            transition: opacity 0.3s, margin-bottom 0.3s;
            margin: auto;
        }
        #addConfigForm.show {
            display: block;
            opacity: 1;
        }
        #addConfigForm input {
            margin: 5px 0;
            padding: 8px;
            width: calc(100% - 16px);
            box-sizing: border-box;
            border: 1px solid #ddd;
            border-radius: 4px;
            transition: border-color 0.3s, box-shadow 0.3s;
        }
        #addConfigForm input:focus {
            border-color: #007BFF;
            box-shadow: 0 0 5px rgba(0, 123, 255, 0.3);
        }
        #addConfigForm button {
            background-color: #007BFF;
            color: white;
            border: none;
            padding: 10px;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s, transform 0.2s;
        }
        #addConfigForm button:hover {
            background-color: #0056b3;
            transform: scale(1.05);
        }
        /* Стили для модального окна */
        #editConfigForm {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background-color: white;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.2);
            display: none;
            opacity: 0;
            transition: opacity 0.3s;
            z-index: 1000;
        }
        #editConfigForm.show {
            display: block;
            opacity: 1;
        }
        #editConfigForm input, #editConfigForm select {
            margin: 5px 0;
            padding: 8px;
            width: calc(100% - 16px);
            box-sizing: border-box;
            border: 1px solid #ddd;
            border-radius: 4px;
            transition: border-color 0.3s, box-shadow 0.3s;
        }
        #editConfigForm input:focus, #editConfigForm select:focus {
            border-color: #007BFF;
            box-shadow: 0 0 5px rgba(0, 123, 255, 0.3);
        }
        #editConfigForm button {
            background-color: #007BFF;
            color: white;
            border: none;
            padding: 10px;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s, transform 0.2s;
        }
        #editConfigForm button:hover {
            background-color: #0056b3;
            transform: scale(1.05);
        }
        .close-btn {
            display: block;
            margin-top: 10px;
            padding: 10px;
            background-color: #dc3545;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            text-align: center;
        }
        .close-btn:hover {
            background-color: #c82333;
        }
        /* Модальное окно для отображения групп */
        #groupListModal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background-color: white;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.2);
            display: none;
            opacity: 0;
            transition: opacity 0.3s;
            z-index: 1000;
        }
        #groupListModal.show {
            display: block;
            opacity: 1;
        }
        #groupTableContainer {
            margin-top: 20px;
        }
        .btn-primary {
        background-color: #007BFF;
        color: white;
        border: none;
        padding: 10px;
        border-radius: 4px;
        cursor: pointer;
        transition: background-color 0.3s, transform 0.2s;
    }

    .btn-primary:hover {
        background-color: #0056b3;
        transform: scale(1.05);
    }

    .btn-primary:active {
        background-color: #004080;
        transform: scale(0.98);
    }
    </style>

<div class="container">
    <button class="add-btn" onclick="toggleAddConfigForm()" style="margin-top: 10px;">+ Add New Config</button>
    <div class="new-block" id="addConfigForm">
        <h2>Add config</h2>
        <div class="form">
            <input type="text" id="name" placeholder="NAME">
            <input type="text" id="database_name" placeholder="DATABASE_NAME">
            <input type="text" id="access_token" placeholder="ACCESS_TOKEN">
            <input type="text" id="user_id" placeholder="USER_ID">
            <input type="text" id="host_id" placeholder="HOST_ID">
            <button type="button" onclick="submitForm()">Add</button>
        </div>
    </div>
</div>


    <div class="table-container" id="tableContainer">
        <div class="row header">
            <div class="cell">#</div>
            <div class="cell">Проект</div>
            <div class="cell">Автор</div>
            <div class="cell">Actions</div>
        </div>

        {% for config in all_configs %}

        <div class="row">
            <div class="cell">{{ loop.index }}</div> <!-- Порядковый номер -->
            <div class="cell">{{ config.name }}</div>
            <div class="cell">{{ config.author.email }}</div>
            <div class="cell">
                <button class="edit-btn" onclick="showEditConfigForm({{ config.id }}, '{{ config.name }}', '{{ config.database_name }}', '{{ config.access_token }}', '{{ config.user_id }}', '{{ config.host_id }}')">Edit</button>
               <button class="delete-btn" onclick="deleteConfig('{{ url_for('delete_config', config_id=config.id) }}')">Delete</button>
            </div>
        </div>
        {% endfor %}
    </div>

    <!-- Форма для редактирования проекта -->
    <div id="editConfigForm">
        <h3>Edit Config</h3>
        <form id="editConfigFormContent" onsubmit="return updateConfig()">
            <input type="hidden" id="editConfigId" name="config_id">

        <div class="form">
            <div class="form-group">
                <label for="editName">Name:</label>
                <input type="text" id="editName" placeholder="NAME">
            </div>
            <div class="form-group">
                <label for="editDatabaseName">Database Name:</label>
                <input type="text" id="editDatabaseName" placeholder="DATABASE_NAME">
            </div>
            <div class="form-group">
                <label for="editAccessToken">Access Token:</label>
                <input type="text" id="editAccessToken" placeholder="ACCESS_TOKEN">
            </div>
            <div class="form-group">
                <label for="editUserID">User Id:</label>
                <input type="text" id="editUserID" placeholder="USER_ID">
            </div>
            <div class="form-group">
                <label for="editHostID">Host Id:</label>
                <input type="text" id="editHostID" placeholder="HOST_ID">
            </div>
            <div class="form-group">
                <button class="btn btn-primary btn-block" type="submit">Save</button>
                <button class="close-btn" type="button" onclick="closeEditConfigForm()">Close</button>
            </div>
        </div>
        </form>
    </div>


<div class="loader" style="display: none;"></div>

<script>
    function DeleteConfigFromGroup(url) {
        $('.loader').show();
        const groupName = $('#group-name-delete-config').val();
        const config = $('#username-delete-config').val();

        fetch(url, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ group_name: groupName, config: config })
        })
        .then(response => {
            if (!response.ok) {
                return response.json().then(errorData => {
                    throw new Error(errorData.detail || 'An unknown error occurred.');
                });
            }
            return response.json();
        })
        .then(data => {
            console.log('Success:', data);
            // Обработка успешного ответа
            $('.loader').hide();
            window.location.reload();
        })
        .catch((error) => {
            console.error('Error:', error);
            alert(error.message); // Показываем сообщение об ошибке
            $('.loader').hide();
        });
    }

    function AddConfigToGroup(url) {
    $('.loader').show();
    const groupName = $('#group-name-add-config').val();
    const config = $('#username-add-config').val();

    fetch(url, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({ group_name: groupName, config: config })
    })
    .then(response => {
        if (!response.ok) {
            return response.json().then(errorData => {
                throw new Error(errorData.detail || 'An unknown error occurred.');
            });
        }
        return response.json();
    })
    .then(data => {
        console.log('Success:', data);
        // Обработка успешного ответа
        $('.loader').hide();
        window.location.reload();
    })
    .catch((error) => {
        console.error('Error:', error);
        alert(error.message); // Показываем сообщение об ошибке
        $('.loader').hide();
    });
}

    function DeleteUserFromGroup(url) {
        $('.loader').show();
        const groupName = $('#group-name-delete-user').val();
        const username = $('#username-delete-user').val();

        fetch(url, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ group_name: groupName, username: username })
        })
        .then(response => {
            if (!response.ok) {
                return response.json().then(errorData => {
                    throw new Error(errorData.detail || 'An unknown error occurred.');
                });
            }
            return response.json();
        })
        .then(data => {
            console.log('Success:', data);
            // Обработка успешного ответа
            $('.loader').hide();
            window.location.reload();
        })
        .catch((error) => {
            console.error('Error:', error);
            alert(error.message); // Показываем сообщение об ошибке
            $('.loader').hide();
        });
    }

    function submitForm() {
        $('.loader').show();
        const formData = {
            name: $('#name').val(),
            database_name: $('#database_name').val(),
            access_token: $('#access_token').val(),
            user_id: $('#user_id').val(),
            host_id: $('#host_id').val()
        };

        fetch('{{ url_for('add_config') }}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(formData)
        })
        .then(response => {
            if (!response.ok) {
                return response.json().then(errorData => {
                    throw new Error(errorData.detail || 'An unknown error occurred.');
                });
            }
            return response.json();
        })
        .then(data => {
            console.log('Success:', data);
            // Обработка успешного ответа
            $('.loader').hide();
            window.location.reload();
        })
        .catch((error) => {
            console.error('Error:', error);
            alert(error.message); // Показываем сообщение об ошибке
            $('.loader').hide();
        });
    }

    document.addEventListener('DOMContentLoaded', function() {
        // Загрузка списка ролей при загрузке страницы
        fetch('{{ url_for('get_roles') }}')  // URL вашего эндпоинта для получения ролей
            .then(response => response.json())
            .then(data => {
                const roleSelect = document.getElementById('role-select');
                data.roles.forEach(role => {
                    const option = document.createElement('option');
                    option.value = role;
                    option.text = role;
                    roleSelect.add(option);
                });
            })
            .catch((error) => {
                console.error('Error loading roles:', error);
            });

        // Загрузка списка пользователей при загрузке страницы
        fetch('{{ url_for('get_usernames') }}')  // URL вашего эндпоинта для получения пользователей
            .then(response => response.json())
            .then(data => {
                const usernameSelect = document.querySelector('.group-username');
                data.usernames.forEach(username => {
                    const option = document.createElement('option');
                    option.value = username;
                    option.text = username;
                    usernameSelect.add(option);
                });
            })
            .catch((error) => {
                console.error('Error loading usernames:', error);
            });

        // Загрузка списка конфигураций при загрузке страницы
        fetch('{{ url_for('get_configs') }}')  // URL вашего эндпоинта для получения конфигураций
            .then(response => response.json())
            .then(data => {
                const configSelect = document.querySelector('.group-config');
                data.configs.forEach(config => {
                    const option = document.createElement('option');
                    option.value = config;
                    option.text = config;
                    configSelect.add(option);
                });
            })
            .catch((error) => {
                console.error('Error loading configs:', error);
            });
    });

    function addUsernameField() {
        // Создаем новый контейнер для select
        const newWrapper = document.createElement('div');
        newWrapper.className = 'select-wrapper';
        newWrapper.innerHTML = `
            <select class="group-username" placeholder="Select Username">
                <!-- Опции будут добавлены через JavaScript -->
            </select>
        `;
        // Добавляем новый контейнер в DOM
        document.getElementById('username-fields').appendChild(newWrapper);

        // Небольшая задержка перед загрузкой данных
        setTimeout(() => {
            // Загрузка списка пользователей для нового поля
            fetch('{{ url_for('get_usernames') }}')
                .then(response => response.json())
                .then(data => {
                    const newUsernameSelect = newWrapper.querySelector('.group-username');
                    data.usernames.forEach(username => {
                        const option = document.createElement('option');
                        option.value = username;
                        option.text = username;
                        newUsernameSelect.add(option);
                    });
                })
                .catch((error) => {
                    console.error('Error loading usernames:', error);
                });
        }, 100); // Задержка в 100 миллисекунд
    }

    function addConfigField() {
        // Создаем новый контейнер для select
        const newWrapper = document.createElement('div');
        newWrapper.className = 'select-wrapper';
        newWrapper.innerHTML = `
            <select class="group-config" placeholder="Select Config">
                <!-- Опции будут добавлены через JavaScript -->
            </select>
        `;
        // Добавляем новый контейнер в DOM
        document.getElementById('config-fields').appendChild(newWrapper);

        // Небольшая задержка перед загрузкой данных
        setTimeout(() => {
            // Загрузка списка конфигураций для нового поля
            fetch('{{ url_for('get_configs') }}')
                .then(response => response.json())
                .then(data => {
                    const newConfigSelect = newWrapper.querySelector('.group-config');
                    data.configs.forEach(config => {
                        const option = document.createElement('option');
                        option.value = config;
                        option.text = config;
                        newConfigSelect.add(option);
                    });
                })
                .catch((error) => {
                    console.error('Error loading configs:', error);
                });
        }, 100); // Задержка в 100 миллисекунд
    }
</script>

<script>

    function toggleAddConfigForm() {
        const form = document.getElementById('addConfigForm');
        const tableContainer = document.getElementById('tableContainer');
        if (form.classList.contains('show')) {
            form.classList.remove('show');
            tableContainer.style.marginTop = '20px'; // Возвращаем отступ
        } else {
            form.classList.add('show');
            tableContainer.style.marginTop = '180px'; // Увеличиваем отступ
        }
    }


    function showEditConfigForm(configId, name, databaseName, accessToken, userID, hostID  ) {
        document.getElementById('editConfigId').value = configId;
        document.getElementById('editName').value = name;
        document.getElementById('editDatabaseName').value = databaseName;
        document.getElementById('editAccessToken').value = accessToken;
        document.getElementById('editUserID').value = userID;
        document.getElementById('editHostID').value = hostID;
        document.getElementById('editConfigForm').classList.add('show');
    }

    function closeEditConfigForm() {
        document.getElementById('editConfigForm').classList.remove('show');
    }

    function updateConfig() {
        const configId = document.getElementById('editConfigId').value;
        const name = document.getElementById('editName').value;
        const databaseName = document.getElementById('editDatabaseName').value;
        const accessToken = document.getElementById('editAccessToken').value;
        const userID = document.getElementById('editUserID').value;
        const hostID = document.getElementById('editHostID').value;

        // Собираем данные для отправки
        const data = {
            name: name,
            databaseName: databaseName,
            accessToken: accessToken,
            userID: userID,
            hostID: hostID
        };

        const url = "{{ url_for('edit_config', id='config_id') }}".replace('config_id', configId);

        // Отправляем данные на сервер через PUT запрос
        fetch(url, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(data),
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 200) {
                alert(data.message);  // Сообщение об успешном обновлении
                location.reload();     // Перезагрузка страницы для обновления таблицы
            } else {
                alert('Failed to update config');
            }
        })
        .catch(error => {
            console.error('Error updating config:', error);
            alert('An error occurred while updating the config.');
        });

        return false;  // Предотвращаем отправку формы по умолчанию
    }

    function deleteConfig(url) {
        if (confirm('Are you sure you want to delete this config?')) {
            fetch(url, {
                method: 'DELETE'
            }).then(response => response.json())
              .then(data => {
                  if (data.status === 200) {
                      alert(data.message);
                      location.reload(); // Перезагружаем страницу после удаления
                  } else {
                      alert('Failed to delete config');
                  }
              });
        }
    }
</script>
{% endblock %}
